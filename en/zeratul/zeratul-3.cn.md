君正Zeratul开发(3)——升级回滚
-------------------------

### 升级

升级有两种方案：直接升级方案，recovery 升级

直接升级方案与其他嵌入式设备升级方式一样，就是从不同地方(OTA,U盘，TF卡等)获取升级文件,然后将需要升级的数据烧录到指定的flash分区地址去就可以了。

__recovery__ 升级是当系统启动异常或是接收到recovery命令的时候，设备进入recovery模式，这个模式是一个精简的系统，一般只初始化跟升级相关的外设，一般也只进行升级相关的业务。

### 直接升级

直接升级方案的几个分区升级方法如下：
- __boot__： 系统启动后 boot 分区不再进行访问， 因此可以直接擦除再写入。 注意：bootloader 如果损坏， 设备将无法启动， 只能进行售后修理（只能进行 TF 卡启动恢复， 或者更换存储芯片）
- __tag__： tag 分区没有挂载， 可以随时写入， 但要注意擦写时需要与修改 tag 的动作做互斥（比如更新系统 env 参数）
- __uImage__： uImage 是在 bootloader 阶段加载的， 在 uImage 运行起来之后， 也不会访问 uImage 存储分区， 因此可以随时擦除并写入升级后的数据
- __rootfs__： 类似于 uImage， rootfs 可以随时擦除并写入新的数据
- __recovery__： 系统正常启动不挂载 recovery 分区， 因此 recovery 分区可以随时擦除并写入
- __system__： 由于 system 分区存放系统的常用资源， 所以再烧写之前需要 kill 掉system 上执行的程序， close system 的文件句柄， 并 umount system 分区，再进行擦除写入操作
- __config__： config 分区是 rw 分区， 可以直接修改文件内容或添加删除文件。

### recovery 升级

#### 概念介绍：

Recovery 系统： Recovery 系统是一个独立的小型操作系统， 在一个 bin 中包含uImage 以及 rootfs。 即使正常系统的 rootfs 和 uImage 破坏， 也可以进入 recovery系统。

recovery 命令： 系统中执行 recovery 命令， 会重起并进入 recovery 系统

#### 升级步骤：

将升级的 fw 下载到 TF 卡中， 执行 recovery 命令， 系统重起后进入 recovery 系统进行升级一个参考的例子是 tools/host/mk_update 目录下的 TF 卡 recovery 升级方式， TF 卡中存放 UPDATE.zip 升级包， 进入 recovery 后会执行脚本， 执行升级操作。

### 回滚

uboot的SPL 启动之后，它会去tag分区获取启动参数和启动文件，并且会去校验各个分区的数据是否正常，如果数据都正常，uboot 的SPL就会引导系统快速启动，如果数据异常，那么uboot SPL 就会引导 uboot 的normal boot 启动，这也就是我们常说的boot启动的第二阶段，这个阶段是我们用户自己编译的boot,然后他会引导recovery 里面的kernel 和rootfs 启动，这样就进入了最简的recovery 系统里面。

如果用户需要自定义回滚升级，那么直接更新放在文件系统里的升级程序就可以了。

#### 说明：

因为君正boot 启动第一阶段的SPL 代码并没有开放，所以设备的回滚只能按照官方的这种方式进行回滚，如果有SPL部分的代码，实际上还可以将flash 分成两个区，一个正常启动区，一个是备份区，当一个区不能正常启动的时候，更换到另外一个分区去启动。这样的好处就是比较安全，不存在说会设备挂掉，坏处就是flash 空间会增加一倍，

######################2022.08.28######################  
该博客将停止更新  
新的文章内容和附件工程文件  
请到 liwen01 博客首页信息查询  
liwen01 2022.08.28 日更新  
######################2022.08.28######################
