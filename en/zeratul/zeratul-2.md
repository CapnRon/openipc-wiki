Ingenic Zeratul Development
===========================

U-Boot Boot Analysis
--------------------

### Preface

The boot is generally divided into two stages, the first stage of the Ingenic
device uboot spl program is not open source, the user compiled the second
stage of the boot, and finally the two stages of the boot are merged together
and written to the boot partition, the boot partition is as follows:

![](image4.png)

### I. SPL (secondary program loader)

SPL (secondary program loader) is a very small bin file that is used to boot
the main u-boot file. For some SOCs with small SRAM, it is not possible to
load the bootloader from the ROM into the SRAM at once, because generally the
SRAM is much smaller than the size of the bootloader. This is when SPL comes
into being.

#### Loading process

The internal SOC of the embedded system will have a relatively small SRAM, 
while the external one will generally have DDR or SDRAM, and the RAM behind
is the external RAM; SPL will be loaded into SRAM first, then initialize DDR
or SDRAM, and in any case will initialize the external RAM, and then load the
main u-boot into RAM; as shown in the following figure:

![](image5.png)

- ① in the figure is the loading procedure of SPL in the first stage of u-boot,
  initializing the most basic hardware, such as turning off interrupts, 
  initializing memory, setting up the stack and other most basic operations,
  setting up relocation;
- ② in the figure is the program that will load the main u-boot, then initialize
  other board-level hardware, such as network cards, nand flash, etc., and set
   the commands and environment variables for u-boot itself;
- ③ in the figure is loading the kernel to RAM and then booting the kernel;

### II. U-Boot

In Ingenic device, this part is called normal boot, it is similar to the boot we
use in other platforms, and the code is open source, so users can customize and
modify it.

#### Compilation

The u-boot can be compiled separately and does not depend on other code. The board
configuration file for T31 u-boot is located in `include/configs/isvp_t31.h`.
The compile command can query Ingenic for the corresponding device, for example,
the command to compile U-Boot for use with NOR Flash Memory chip for the T31X 
is as follows:
```
make isvp_t31_sfcnor_ddr128M
```

The command to compile U-Boot for use with SD card boot for the T31X chip is as follows:
```
make isvp_t31_msc0_ddr128M
```

Compilation steps:

1. Run `$ make distclean` to clear the old configuration
2. Run `$ make isvp_t31_xxx` to compile the u-boot and `u-boot-with-spl.bin`
   for the corresponding chip type (see "Chip Version Description" for the chip model).

#### Common modifications

1) __CONFIG_BOOTARGS__, the main modification point is the memory configuration
   and partition size configuration after the kernel boots. (Note: mem means
   reserved memory after kernel boot, rmem means memory reserved for SDK
   (including memory for ISP module); the sum of the two is the real memory
   size of the chip; the specific size can be referred to the code)

2) __CONFIG_BOOTCOMMAND__, configure the commands to be executed by uboot boot.
   For example: `norflash boot`. Add the command for sd card boot in boot mode,
   "sf probe; sf read 0x80600000 0x40000 0x280000; bootm 0x80600000" to
   "mmc read 0x80600000 0x1800 0x3000; bootm 0x80600000".

3) __CONFIG_BOOTDELAY__, configure the waiting time of uboot.

4) Need to add new NOR flash chip support.

5) Add password function in U-Boot. Modify the configuration in `isvp_t31.h` file
   to add the following content:
   ```
   #define CONFIG_AUTOBOOT_KEYED // mandatory
   #define CONFIG_AUTOBOOT_STOP_STR "123456" // mandatory, password set by uboot.
   #define CONFIG_AUTOBOOT_PROMPT "Press xxx in %d second" // bootdelay, optional.
   ```

6) SD card upgrade problem.
   Add `#define CONFIG_AUTO_UPDATE` definition in `isvp_t31.h`.
   The specific code implementation is in `common/cmd_sdupdate.c`.
   Note: `LOAD_ADDR` indicates the location where the corresponding memory on
   the SD card is loaded into memory. The default setting in the program is `0x82000000`.
   Since this address is located on the heap of uboot, the common uboot heap size
   setting is configured in the `CONFIG_SYS_MALLOC_LEN` macro in `isvp_t31.h`.
   Therefore, the size of this address can be used will be limited by the heap size
   and the malloc space in the uboot code. in the uboot code.
   (Note: If you need to read larger files, you can increase `CONFIG_SYS_MALLOC_LEN`
   appropriately)

7) Compiled uboot is larger than the size limit.  
   The default limit in the uboot code is 26Kbytes for the spl part and 214Kbytes
   for the uboot part; the total size limit is 240Kbytes. If the `u-boot-with-spl.bin`
   file generated by uboot compilation is larger than 240Kbytes, it cannot be booted.  
   - Solution 1: Increase the limit of uboot;
      modify the definition of `CONFIG_SYS_MONITOR_LEN` macro in `isvp_t31.h`;
      also modify the size of the boot partition and the offset address of the future
      partition in the `CONFIG_BOOTARGS` variable.  
   - Solution 2: If the generated `u-boot-with-spl.bin` is less than 240 Kbytes,
      you can compress the uboot. In `isvp_t31.h`, change `#undef CONFIG_SPL_LZOP` to
      `#define CONFIG_SPL_LZOP`; then recompile the burned file name `u-boot-lzo-with-spl.bin`

8) uboot network problems  
   The default ISVP configuration contains the Ethernet part of the code,
   if the product does not need TFTP download or NFS mount in the uboot stage, you can
   cut out the Ethernet part of the code in order to reduce the uboot.

### III. Merge

Ingenic's official SPL program and the user's own compiled `boot.bin` need to
be merged together and burned into the boot partition at the same time.
Ingenic has a merge script. You can pad your own u-boot into `boot.bin` via
`build/pad_camera_u-boot.sh`

Usage of the script:
```
./pad_camera_u-boot.sh -i <input_file> -o <output_file> -b <boot.bin fw>
```
e.g.
```
./pad_camera_u-boot.sh -i u-boot-with-spl.bin -o boot_custom \
   -b ${ZRT_ENV_TOP_DIR}/firmware/camera/bootloader/boot.bin
```

The actual command is executed afterward as follows
```
cp ${BOOT_FILE} ${OUTPUT_FILE}
dd if=${INPUT_FILE} of=${OUTPUT_FILE} bs=1K skip=${UBOOT_OFFSET} seek=${UBOOT_OFFSET}
```

The actual execution reads `BOOT_FILE` is the low-power fast start firmware
that comes with the SDK, take boot_SOC_T31Z_V2.bin as an example:
```
dd if=u-boot-with-spl.bin of=boot_custom bs=1k skip=32 seek=32
```
where
- `if=filename`: input filename  
- `of=filename`: output filename  
- `bs=bytes`: set the read/output block size to bytes at the same time.  
- `skip=blocks`: start copying from the beginning of the input file after skipping blocks.  
- `seek=blocks`: start copying from the beginning of the output file after skipping blocks.

In fact, the 32K files starting from the `boot_SOC_T31Z_V2.bin` file and the
32K files after the `u-boot-with-spl.bin` file are combined to create a new file.

### Reference:

[U-Boot SPL Learning Summary](https://my.oschina.net/renhc/blog/53580)

######################2022.08.28######################  
This blog will not be updated  
New article content and attached project files  
Please go to liwen01 blog home page for information  
liwen01 updated on 2022.08.28  
######################2022.08.28######################
